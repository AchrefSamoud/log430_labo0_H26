name: CD - Continuous Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Stop existing containers
      run: |
        cd ~/log430_labo0_H26
        docker-compose down || true
      
    - name: Pull latest changes
      run: |
        cd ~/log430_labo0_H26
        git pull origin main
      
    - name: Build Docker image
      run: |
        cd ~/log430_labo0_H26
        docker-compose build
      
    - name: Start containers
      run: |
        cd ~/log430_labo0_H26
        docker-compose up -d
      
    - name: Run tests
      run: |
        cd ~/log430_labo0_H26
        docker-compose exec -T calculator pytest src/tests/ -v
      
    - name: Deployment status
      run: |
        echo "âœ… Deployment successful!"
        docker ps | grep calculator
